# Data Model

## Entity Definitions

### User

**Purpose**: Represents registered users with authentication and profile information

**Attributes**:

- `user_id` (UUID, Primary Key): Unique identifier generated by Supabase Auth
- `full_name` (VARCHAR(100), Required): User's full name for personalization
- `email` (VARCHAR(255), Unique, Required): Authentication email, managed by Supabase Auth
- `role` (ENUM: 'user', 'admin', Default: 'user'): Role-based access control
- `profile_image` (TEXT, Optional): URL to profile image in Supabase Storage
- `latitude` (DECIMAL(10,8), Optional): User location for facility recommendations
- `longitude` (DECIMAL(11,8), Optional): User location for facility recommendations
- `location_permission` (BOOLEAN, Default: false): Consent for location-based features
- `location_updated_at` (TIMESTAMP WITH TIME ZONE, Optional): Last location update timestamp
- `created_at` (TIMESTAMP WITH TIME ZONE, Default: NOW()): Account creation timestamp
- `updated_at` (TIMESTAMP WITH TIME ZONE, Default: NOW()): Last profile update timestamp

**Validation Rules**:

- Email format validation handled by Supabase Auth
- Full name minimum 2 characters
- Latitude range: -90 to 90 degrees
- Longitude range: -180 to 180 degrees
- Location permission required for storing coordinates

**State Transitions**:

- Registration → Active user (email verification via Supabase)
- Location permission granted → Coordinates stored
- Profile updates → updated_at timestamp refreshed
- Account deletion → All related data cascade deleted (FR-014)

### Waste_Category

**Purpose**: Defines the three classification types with disposal guidance

**Attributes**:

- `waste_category_id` (UUID, Primary Key): Unique category identifier
- `category_name` (VARCHAR(50), Required): Human-readable name ('Organik', 'Anorganik', 'Lainnya')
- `category_code` (VARCHAR(10), Unique, Required): System code ('ORG', 'ANO', 'LAI')
- `description` (TEXT, Required): Detailed category description in Indonesian
- `education_content` (TEXT, Required): Jakarta-specific disposal best practices (FR-010)
- `created_at` (TIMESTAMP WITH TIME ZONE, Default: NOW())
- `updated_at` (TIMESTAMP WITH TIME ZONE, Default: NOW())

**Validation Rules**:

- Category name must be one of predefined values
- Category code must be unique 3-letter code
- Education content minimum 100 characters

**Relationships**:

- One-to-many with Classification (classification results)
- Many-to-many with Waste_Facility (facility acceptance rules)

### Classification

**Purpose**: Records individual waste classification attempts with complete audit trail

**Attributes**:

- `classification_id` (UUID, Primary Key): Unique classification identifier
- `user_id` (UUID, Foreign Key → User): Owner of classification
- `waste_category_id` (UUID, Foreign Key → Waste_Category): Final classification result
- `image_filename` (VARCHAR(255), Required): Original uploaded filename
- `image_path` (TEXT, Required): Supabase Storage path/URL
- `original_filename` (VARCHAR(255), Required): User's original file name
- `confidence_organik` (DECIMAL(5,2), Range: 0.00-100.00): ML confidence for Organik category
- `confidence_anorganik` (DECIMAL(5,2), Range: 0.00-100.00): ML confidence for Anorganik category
- `confidence_lainnya` (DECIMAL(5,2), Range: 0.00-100.00): ML confidence for Lainnya category
- `education_content` (TEXT, Optional): Contextual disposal recommendations
- `created_at` (TIMESTAMP WITH TIME ZONE, Default: NOW()): Classification timestamp
- `updated_at` (TIMESTAMP WITH TIME ZONE, Default: NOW()): Last modification timestamp

**Validation Rules**:

- All confidence scores must sum to approximately 100.00 (±0.01 tolerance)
- Image file size ≤ 10MB (validated before upload - FR-001)
- Supported formats: JPEG, PNG, WebP (FR-001)
- Low confidence warning when max confidence < 70% (FR-003a)

**Relationships**:

- Many-to-one with User (user's classification history)
- Many-to-one with Waste_Category (classification result)

### Waste_Facility

**Purpose**: Jakarta waste management facilities for disposal recommendations

**Attributes**:

- `facility_id` (UUID, Primary Key): Unique facility identifier
- `facility_name` (VARCHAR(200), Required): Official facility name
- `facility_type` (ENUM: 'TPS', 'TPA', 'Bank Sampah', Required): Facility classification
- `latitude` (DECIMAL(10,8), Required): Geographic coordinate for mapping
- `longitude` (DECIMAL(11,8), Required): Geographic coordinate for mapping
- `address` (TEXT, Required): Complete facility address
- `city` (VARCHAR(100), Required): City location (primarily Jakarta)
- `created_at` (TIMESTAMP WITH TIME ZONE, Default: NOW())
- `updated_at` (TIMESTAMP WITH TIME ZONE, Default: NOW())

**Validation Rules**:

- Facility name minimum 5 characters
- Latitude/longitude must be valid Jakarta area coordinates
- Address minimum 20 characters

**Relationships**:

- Many-to-many with Waste_Category (accepted waste types)

### Waste_Facility_Category

**Purpose**: Junction table defining which waste types each facility accepts

**Attributes**:

- `facility_id` (UUID, Foreign Key → Waste_Facility): Facility reference
- `waste_category_id` (UUID, Foreign Key → Waste_Category): Accepted category
- `created_at` (TIMESTAMP WITH TIME ZONE, Default: NOW())
- `updated_at` (TIMESTAMP WITH TIME ZONE, Default: NOW())

**Primary Key**: Composite (facility_id, waste_category_id)

**Business Rules** (FR-016):

- TPS facilities typically accept all waste categories
- Bank Sampah primarily accepts Anorganik (recyclable) waste
- TPA accepts processed waste from TPS facilities

**Validation Rules**:

- Prevent duplicate facility-category combinations
- Both foreign keys must exist and be valid

## Data Relationships

```
User (1) ←→ (N) Classification
Classification (N) ←→ (1) Waste_Category
Waste_Category (N) ←→ (N) Waste_Facility [via Waste_Facility_Category]
```

## Indexes & Performance

**Primary Indexes**:

- `classifications_user_created` (user_id, created_at DESC) - User history queries
- `classifications_category` (waste_category_id) - Admin analytics
- `facilities_location` (latitude, longitude) - Geospatial queries for mapping
- `facilities_type` (facility_type) - Facility filtering

**Search Optimization**:

- Full-text search on facility_name and address for facility discovery
- Composite index on (user_id, created_at) for efficient pagination of user history

## Row-Level Security (RLS) Policies

**User Table**:

- Users can read/update their own profile only
- Admins can read all user records (no personal data modification)

**Classification Table**:

- Users can read/create/delete their own classifications only
- Admins can read all classifications for analytics
- Cascade delete when user account is deleted (FR-014)

**Waste_Category & Waste_Facility Tables**:

- Read access for all authenticated users
- Write access for admins only (reference data management)

**Data Retention**:

- User data retained indefinitely until explicit deletion (Clarification 2)
- Classification history follows user data retention policy
- System audit logs retained separately for admin analytics
